---
title: "Ваши Monero уничтожаются ради забавы, а вовсе не для извлечения прибыли"
date: "2021-05-29"
categories:
  - "Статьи"
tags:
  - ""
lead: "Отсутствие верификации времени разблокировки на аппаратных кошельках Monero, вероятно, позволяло взломанному хосту навсегда блокировать XMR пользователя после проведения транзакции. Как Trezor, так и Ledger решили эту проблему."
pager: true
toc: false
sidebar: "right"
---

В каждой транзакции Monero имеется поле под названием unlock_time. В нём указывается, в течение какого времени после создания транзакции выходы будут заблокированы, прежде чем их можно будет потратить снова. Выходы транзакции с полем unlock_time с нулевым значением могут быть потрачены сразу же или, по крайней мере, сразу после обычного времени блокировки, то есть, через 10 блоков. Если значение поля unlock_time будет на 100 блоков больше значения текущей высоты блока, получателю придётся подождать в течение 100 блоков, пока он, наконец, снова не сможет потратить соответствующие выходы.

Максимальное допустимое количество блоков составляет 500 000 000 – 1, и на майнинг такого числа блоков, вероятно, уйдёт примерно 1900 лет. Если значение превысит этот предел, поле unlock_time будет интерпретировано в соответствии с временем Unix, выраженным в секундах. Поскольку это 64-битное поле, оно позволяет блокировать монеты на срок, составляющий более ста миллиардов лет.

Аппаратные кошельки должны обеспечивать защиту пользователей от кражи средств, вымогательства и потери монет вследствие установки вредоносных программ на их компьютеры. От кошельков Monero, будь это Trezor Model T или Ledger Nano S/X, также ожидается именно это. Аппаратные кошельки должны проверять всю информацию, которая передается им хостом, гарантируя тем самым, что монеты пользователя находятся и впредь будут находиться в безопасности.

Аппаратные кошельки Ledger и Trezor не проверяли поле unlock_time при подписании транзакции. Злоумышленник, установивший вредоносное ПО на хост-машину пользователя, мог навсегда заблокировать монеты пользователя, задав слишком высокое значение unlock_time. Поскольку суммы сдачи не проверяются устройствами, все средства пользователя могли быть заблокирован, даже если пользователь провёл самую незначительную транзакцию.

Как Trezor, так и Ledger решили эту проблему. Trezor было достаточно [внести корректировки в прошивку](https://github.com/trezor/trezor-firmware/commit/7944c1a837cb8b7c398be0ab6361d229ac591eab), поскольку пол unlock_time уже было разобрано как часть их логической схемы транзакций. И Trezor, и Ledger отображают необработанное число на экране, поэтому зависящие от высоты блока и времени значения unlock_times отображаются таким же образом.

![01](/img/copyright/2021-05-29-wallet-timelock/01.jpg)

Ledger не реализовал никакой логики unlock_time в своей прошивке, так что пришлось [вносить исправления в прошивку](https://github.com/LedgerHQ/app-monero/commit/2e2692f31a0e904fb6f6c907a52842696f5352e0), но и написать специальный [патч для кошелька Monero](https://github.com/monero-project/monero/commit/688a3e87e712123d182ae6715610c461988f9e74).

К сожалению, первая версия патча только добавила проблем. Разобранное поле unlock_time, которое может являться любым 64-битным числом, было преобразовано в 32-битное целое число со знаком, что привело к переполнению целого числа. В зависимости от значения, устройство либо прекращает работу, либо, что ещё хуже, показывает неверное значение unlock_time. После некоторого поиска причины такого поведения, эта дополнительная проблема [также была исправлена](https://github.com/LedgerHQ/app-monero/pull/81).

![02](/img/copyright/2021-05-29-wallet-timelock/02.jpg)

Как [Trezor](https://blog.trezor.io/details-of-firmware-updates-for-trezor-one-version-1-9-0-and-trezor-model-t-version-2-3-0-46deb141fc09) так и [Ledger](https://donjon.ledger.com/lsb/009/) опубликовали рекомендации по обеспечению безопасности в связи с этой проблемой, указали меня в качестве источника информации и выплатили щедрое вознаграждение за обнаружение ошибок.

---

_Источник: [Destroying your moneroj for fun and not for profit](https://thecharlatan.ch/Wallet-Timelock/)_

_Перевод: [Mr. Pickles](https://t.me/v1docq47)_  
_Коррекция: [Kukima](https://t.me/Kukima)_

---
title: "Стефанос Халиасос - Систематизация знаний: чего мы не знаем? Понимание уязвимостей в безопасности доказательств SNARKs"
date: "2024-06-07"
categories:
  - "Стенограмма"
tags:
  - "MoneroKon 2024"
lead: "Monero Konferenco 2024 #MoneroKon2024 Прага"
pager: true
toc: false
sidebar: "right"
---

{{< youtube id="gIoCnyc2wQw" autoplay="false" >}}

---

_**Аннотация выступления**_

Доказательства с нулевым разглашением (ZKP) прошли путь от теоретической концепции, обеспечивающей приватность и проверяемость, до практической реализации в реальном мире, причём неинтерактивные доказательства с нулевым разглашением (SNARKs) стали одной из наиболее значимых инноваций. Предыдущие работы в основном были направлены на разработку более эффективных систем SNARKs и доказательств безопасности для них. Многие считают SNARKs "просто математической концепцией", подразумевая, что то, что доказано как правильное и безопасное, является таковым на практике. Вопреки этому мнению данная статья посвящена оценке свойств сквозной безопасности реальных вариантов реализации доказательств SNARKs, начиная с построения базовой модели системы, моделирования угроз и ролей злоумышленников, которые могут атаковать системы, использующие SNARKs. Исследование включает в себя обширный анализ 141 фактической уязвимости в реализованных системах SNARKs, содержит подробную классификацию, которые помогут разработчикам и исследователям безопасности в понимании соответствующих угроз. Наконец, в исследовании приводится оценка существующих механизмов защиты и предлагаются рекомендации по повышению безопасности систем на базе доказательств SNARKs, что открывает путь к созданию более надёжных и прочных вариантов их реализации в будущем.

_**Стенограмма выступления:**_

_**Стефанос:**_ Спасибо за вступление. С вашего позволения сначала пара слов о себе. Я являюсь аспирантом Имперского колледжа, но также занимаюсь аудитом безопасности доказательств с нулевым разглашением. В основном я занимаюсь языками программирования, компьютерной безопасностью и вопросами приватности. Но последние несколько лет я в основном работаю над проблемами безопасности блокчейнов, в частности, безопасности смарт-контрактов, а в последнее время - безопасности доказательств ZKP, то есть, провожу анализ, тестирую концепции ZKP на вирусность и так далее.

В своём выступлении я расскажу о свих последних исследованиях уязвимости доказательств с нулевым разглашением. Что это значит? Это значит, что когда мы используем такое доказательство, возможно проведение какого-нибудь нового вида атаки. Мы начнём с небольшой вводной части, а затем я расскажу о нашей модели для систем, использующих доказательства ZKP. После этого я предельно кратко расскажу о потенциальных последствиях использования этих уязвимостей, представлю модель угрозы, после чего представлю основную часть нашей работы, то есть приведу классификацию уязвимостей в доказательствах с нулевым разглашением. И наконец, мы кратко обсудим средства защиты.

Итак, что такое доказательства с нулевым разглашением, и как они используются сегодня? Итак, для тех, кто не знает, доказательства с нулевым разглашением представляют собой криптографические протоколы, позволяющие доказывающей стороне доказать какое-либо утверждение верификатору, в идеале практически ничего не раскрывая в связи с этим утверждением. Это и будет доказательством нулевым разглашением.

Основным применением таких доказательств, очевидно, является использование протокола, обладающего свойством нулевого разглашения. Чуть позже я дам определение этого свойства, но, по сути, это подразумевает возможность проведения приватных транзакции и так далее. Но сегодня эти доказательства используются в основном для обеспечения масштабируемости. Что это значит? Это значит, что у нас есть несколько блокчейнов, которые мы называем роллапами или блокчейнами второго уровня, и в этих блокчейнах мы производим все вычисления, а затем передаём доказательства достоверности транзакций, вычисленных в таких вспомогательных блоках, в блокчейн первого уровня. На данный момент в этом и заключается основное применение доказательств с нулевым разглашением.

Также у нас есть Zcash, являющийся блокчейном первого уровня с возможностью проведения приватных транзакций. У нас есть Filecoin, система, широко использующая доказательства с нулевым разглашением, и ещё несколько приложений. Но, несмотря на растущее количество протоколов и систем, использующих эти доказательства, мы до сих пор не наблюдали эксплойта, злонамеренного взлома любого из этих протоколов.

Однако в этих протоколах уже были обнаружены довольно серьёзные уязвимости. Например, в Zcash была выявлена ошибка, которая скрывалась почти в течение двух лет после развёртывания. Её обнаружил и исправил кто-то из команды разработчиков. В одной из основных схем Tornado Cash также была обнаружена очень, я бы сказал, наивная уязвимость. Схемами мы называем программы доказательства с нулевым разглашением. Она была обнаружена белым хакером и исправлена командой Tornado Cash. Затем в одном из роллапов была обнаружена критическая уязвимость, которая, по сути, позволяла полностью присвоить TVL, забрать все активы, заблокированные в этом блокчейне. А недавно, буквально месяц назад, в ходе аудита была обнаружена ещё одна уязвимость в развёрнутой системе. То есть в системах было обнаружено несколько очень серьёзных уязвимостей, но ни одна из них не была толком изучена.

Основная причина, по которой сложилась такая ситуация, состоит в том, что люди считают, что доказательства с нулевым разглашением сложны сами по себе, написание схем - ещё сложнее, а обнаружение уязвимостей и проведение атак - сложнее в разы. Но мы считаем, что с учётом последних событий и того, что всё больше людей использует доказательства с нулевым разглашением, схемы и так далее, уязвимости скоро можно будет обнаружить и использовать без каких-либо сложностей. Например, уязвимость ZCash была связана с проблемой в одной из базовых библиотек. Вот, собственно, программа, которая была уязвима. Проблема заключалась в том, что в строке 24 вместо того, чтобы использовать один символ, означающий "присвоить значение и ограничение", присваивалось только это значение. И это привело к уязвимости, которая при желании позволяла вывести все средства из Tornado Cash.

Вследствие всего этого было решено классифицировать проблемы безопасности, связанные с доказательствами с нулевым разглашением. И одним из первых действий стало создание разработчиком 0xPARС баг-трекера, который можно найти на GitHub. Также появилось несколько презентаций на тему классификации доказательств с нулевым разглашением. Одна - в 2022 году, другая - в 2024. При этом не проводилось никакой систематической работы, которая позволила бы лучше понять, почему появляются уязвимости и как их обнаружить. И мы решили проделать эту работу. Первая её часть сводилась к изучению того, как системы используют SNARKs и доказательства с нулевым разглашением. Сегодня SNARKs - это наиболее распространённый практический вид доказательств с нулевым разглашением.

Итак, мы начинаем с программы. Здесь обозначим её как R, но это может быть любое другое обозначение. Эта программа описывает то, что мы хотим доказать - вычисления, которые мы хотим доказать некоторому верификатору. Программа принимает некоторые открытые и некоторые закрытые входящие данные. Затем нам нужно вручную перевести эту программу и написать схему. Как правило, мы пишем схемы на языках, специфичных для домена SNARKs: например, Halo2, Circom и многие другие. Существует множество языков DSL для написания схем SNARKs. И в этих схемах мы должны определить, как вычислить значения на основе входных данных, а также должны ограничить эти вычисления так, чтобы принимались только правильные. Это можно представить как размещение операторов assert statement в коде. При этом вычислительная часть выполняется доказывающей стороной, а проверочная часть - верификатором.

Затем следует так называемый фронтендом, который, по сути, принимает на вход схему и компилирует её в две составляющие. Первая - это промежуточное представление, которое будет использоваться как входящие данные для бэкенда. Вторая - генератор свидетельств, принимающий открытые и закрытые входные данные, запускающий вычислительную логику схемы и создающий трассировку со всеми промежуточными значениями и конечными выходящими данными схемы.

Далее следует бэкенд. Бэкенд реализует три функции. Функция настройки берёт некоторую общую контрольную строку (в нашем случае это неважно), а в качестве вводных данных берёт промежуточное представление, созданное компилятором. Бэкенд отвечает за создание ключей - эта функция также называется "предобработкой" - на этом этапе создаются ключи доказывающей стороны и верификатора. Затем есть ещё две функции. Доказывающая сторона в качестве вводных данных берёт трассировку, созданную генератором свидетельств, ключ доказывающей стороны и создаёт доказательство. Верификатор в качестве вводных данных берёт только открытую часть трассировки, поскольку из-за свойства нулевого разглашения некоторые части могут быть закрытыми, а также доказательство и ключ верификации, а затем, если доказательство может быть проверено, просто выдаёт true или false, то есть, определяет, является ли доказательство действительным.

И наконец, прикладной уровень, где, по сути, и происходит взаимодействие со SNARKs. Этот уровень можно представить как смарт-контракт, запрашивающий верификатора, проверить, верно ли доказательство в блокчейне. Другим примером интеграционного уровня может быть код, запрашивающий доказывающую сторону, и так далее.

Недавно появилось несколько новых фреймворков под названием ZK-VM, которые, по сути, абстрагируют часть схемы. Теперь вместо того чтобы писать схемы ZKP, можно просто передать свою программу в ZK-VM, а всё остальное будет работать так же, как и раньше.

Также есть все эти уровни иерархии, где на нижнем уровне находятся аппаратное обеспечение, время выполнения и так далее. Затем идёт система доказательств, которая, по сути, является техническим уровнем, теоретической основой SNARKs и доказательств с нулевым разглашением. Кроме того, нам необходимы оптимизированные библиотеки арифметических вычислений и эллиптических кривых. Далее идут фронтенд, бэкенд, схемы и приложения. И любая уязвимость на любом из нижних уровней означает, что практически всё, что было построено поверх них, может быть нарушено. К слову, в данном исследовании мы не принимаем в расчёт уязвимости и уровни, не относящиеся к ZKP.

Итак, одним из основных интересующих нас свойств доказательств с нулевым разглашением, является достоверность знаний, подразумевающая, что нечестная доказывающая сторона не сможет убедить верификатора в достоверности ложного утверждения. Разве что с ничтожно малой вероятностью. Второе свойство подразумевает, что честная доказывающая сторона всегда сможет убедить честного верификатора в верности достоверного утверждения. Поэтому верификатор всегда примет действительные доказательства, если мне удастся создать такое действительное доказательство. И третье: нулевое разглашение означает, что мы не можем получить никакой приватной информации на основе доказательства.

Наша модель угрозы предусматривает три основных типа злоумышленника. Первый - сетевой злоумышленник, который, по сути, наблюдает за всеми публичными сообщениями, между доказывающей стороной и верификатором. При этом он не может взаимодействовать с ними. Возможно, при условии взлома доказательства с нулевым разглашением ему удастся извлечь некоторую ценную приватную информацию. Далее следует пользователь, имеющий злой умысел, но не обладающий возможностями доказательства. То есть для создания доказательства ему необходима доказывающая сторона. Но в остальном он может предоставлять верификатору любые данные. И, наконец,  существует доказывающая сторона, имеющая злой умысел и являющаяся основной моделью угрозы. Она может произвольно генерировать доказательство. И если верификатор будет уязвим, то такая сторона запросто сможет нарушить работоспособность системы. В нашей статье мы немного подробнее рассматриваем эти виды злоумышленников и их возможности.

Итак, что же может пойти не так? Во-первых, может обнаружиться уязвимость, нарушающая целостность доказательства с нулевым разглашением. Что это значит? Это значит, что доказывающая сторона сможет убедить верификатора в достоверности ложности утверждения. Представьте простейший пример: у нас есть схема, которая доказывает, что a + b = c, и в этом случае доказывающая сторона может убедить верификатора, что 1 + 1 = 5, что неверно, а значит, нарушает свойство достоверности.

Также возможно нарушение полноты. Это означает, что мы либо не можем создать действительное доказательство для некоторого действительного утверждения, либо верификатор отвергнет некоторые действительные доказательства, либо мы можем столкнуться с нарушением свойства нулевого разглашения, а это в свою очередь означает утечку информации о приватных частях трассировки.

В ходе нашего исследования была проанализирована 141 уязвимость, взятая либо из аудиторских отчётов, либо из отчётов по наличию уязвимостей, либо из отчётов баг-трекеров. Мы сосредоточили внимание только на критических уязвимостях и не рассматривали уязвимости, не связанные с ZKP. И вот таблица, в которой представлены основные результаты.

Итак, мы классифицируем уязвимости по уровню и по воздействию. Основное воздействие оказывают ошибки, связанные с достоверностью, что является худшим вариантом при использовании доказательств с нулевым разглашением. Также наибольшее количество уязвимостей обнаруживается на уровне схем. Это может быть связано с тем, что большая часть работы направлена на уровень схем. Но это также может быть связано с тем, что в отношении схем мы используем иную модель.

Под разными моделями я подразумеваю то, что, когда вы пишете схему, необходимо учитывать две вещи. Во-первых, вычислительную часть. И в этом примере у нас есть две входные переменные, две временные переменные и одна выходная переменная. Поэтому при чтении схемы должна определяться логика вычислений, то есть понимание, как вычислить временную переменную три, временную переменную четыре и выходную переменную пять. Но при этом вычисления должны ограничиваться. Под ограничением понимается то, каким должно быть значение временной переменной три, каким должно быть значения временной переменной четыре и выходной переменной. Это немного сложно и отличается от обычного программирования. И мы считаем это основной причиной, что подтверждается результатами наших исследований. Иная модель угроз, которую должны рассматривать разработчики, - главная причина наличия множества уязвимостей на уровне схем. Вы также можете представить, что вычислительная часть - это то, что выполняется доказывающей стороной, а ограничения - это то, что проверяется верификатором.

Таким образом, на уровне схем могут появиться уязвимости с недостаточными ограничениями, уязвимости с избыточными ограничениями и вычислительные ошибки. Недостаточность ограничений означает, что где-то мы упустили какое-то ограничение, и поэтому доказывающая сторона может создавать доказательства для недействительных утверждений. Избыточность ограничений означает, что у нас больше ограничений, чем мы хотели добавить, что может привести к проблемам, из-за которых мы не сможем получить доказательства для некоторых утверждений. Вычислительные ошибки по большей части относятся к логике.

Таким образом, существует множество основных причин, и в нашей работе приводится несколько таблиц, описывающих, сколько ошибок возникло из-за каждой из этих причин. Но сегодня я остановлюсь на двух основных причинах на уровне схем.

Первая заключается в том, что в некоторых случаях, чем больше ограничений присутствует в схеме, тем затратней будет доказать её работоспособность с учётом некоторых входных данных. Поэтому на этом уровне производятся всевозможные, иногда довольно сложные оптимизации, и это одна из главных причин, почему у нас так много ошибок. Вторая причина заключается в том, что обычно при написании схем мы работаем с полем, и это не одно и то же поле и не те же целые числа, с которыми мы имеем дело в случае с нашими обычными программами. Это также приводит к появлению некоторых уязвимостей.

У меня есть два примера, и я их, пожалуй, пропущу, но в нашей работе в целом вы найдёте множество примеров.

Далее на интеграционном уровне не так могут пойти четыре основные вещи. Первая - это передача и проверка данных в схему. Это может случиться потому, что в схеме иногда присутствуют некоторые допуски, то есть мы ожидаем, что входы будут иметь определённые значения или находиться в определённом диапазоне. И эти допуски проверяются именно на интеграционном уровне. В некоторых случаях люди забывают об этих допусках, поскольку они недостаточно хорошо документированы или потому что это огромная сложная система, и что-то можно просто забыть.

Кроме того, случаются ошибки делегирования доказательств и составления доказательств, что связано с тем, как используется доказывающая сторона. Кроме того, некоторые из этих приложений, особенно связанные с приватностью, имеют логику, дополняющую доказательства с нулевым разглашением, и в них могут быть общие уязвимости.

Далее, ряд уязвимостей может проявиться со стороны фронтенда и бэкенда. Мы подробно рассказываем об этом в своей работе, но я хочу, чтобы вы поняли, что при наличии уязвимости на уровне фронтенда, даже если схема будет правильной, уязвимостью можно будет воспользоваться. То же самое относится и к уязвимостям в бэкенде.

Сегодня делаются попытки создать инструменты для обнаружения этих уязвимостей и обеспечения безопасности. В основном это делается на уровне схем, но из-за сложности этих систем, а также из-за количества доступных языков DSL результаты не столь значительны. Многие уязвимости просто не удаётся обнаружить, а в случае с некоторыми DSL средства защиты практически отсутствуют. Кроме того, по не было предпринято никаких попыток создать такие инструменты на уровнях фронтенда и бэкенда.

Вдобавок к этому, могут возникнуть проблемы с оригинальными описаниями доказательств с нулевым разглашением, содержащимися в оригинальных документах, что может иметь самые разнообразные последствия, когда всё, что было построено на основе этих систем доказательств, окажется уязвимым.

И в заключение о том, почему возникают ошибки в системах, использующих доказательства с нулевым разглашением. Во-первых, потому что доказательства с нулевым разглашением - это не просто математика, хотя в их основе и лежат довольно хорошие математические схемы. Но ошибки, которые могут нарушить все свойства системы, возникают при их реализации. И вторая причина - здесь я привожу...

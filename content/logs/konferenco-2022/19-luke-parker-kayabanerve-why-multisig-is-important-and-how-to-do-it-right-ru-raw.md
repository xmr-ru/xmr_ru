---
title: "Люк Паркер (kayabaNerve) - В чём важность мультиподписи, и как правильно её реализовать"
date: "2022-06-19"
categories:
  - "Стенограмма"
tags:
  - "MoneroKon 2022"
lead: "Monero Konferenco 2022 #MoneroKon2022 Лиссабон - День 2"
pager: true
toc: false
sidebar: "right"
---

{{< youtube id="2GjK617zt9Q" autoplay="false" >}}

---

_**Люк:**_ В создании мультиподписи участвуют пять человек, контролирующие всё, что происходит с криптовалютой внутри вашей компании. И один отдельно взятый человек не сможет украсть ваши средства, потому что для создания подписи нужны все пятеро.

Избыточность в случае с пороговыми подписями заключается в том, что вы можете строить пороговые подписи по схеме «2 из 3», что, по-моему, уже предлагалось здесь кем-то, и если вы потеряете ключ, вы сможете восстановить его, поскольку для этого необходимо только два ключа, которые у вас имеются. То есть, если кто-то умрёт, как было в случае с биржей Quadriga CX, даже тогда вы не потеряете все свои средства, пока ваши клиенты будут сохранять платёжеспособность.

Кроме того, существуют более современные способы. Один из них - атомные свопы, о которых я буду говорить, когда перейду к одному из следующих слайдов, а также децентрализованное кастодиальное хранение согласно протоколам, о котором я также говорил ранее в контексте децентрализованных бирж. И, наконец, платёжные каналы, о которых только что прекрасно рассказал Seth.

Как правило, платёжные каналы строятся по схеме мультиподписи «2 из 2», поскольку обе стороны в любой момент времени должны иметь возможность договориться о ставке, используя скрипты для отзыва в случае необходимости. Теперь что касается конкретно атомных свопов. В соответствии с протоколом атомных свопов Monero пользователи в рамках схемы мультиподписи «2 из 2» сначала блокируют свой Bitcoin, а затем блокируют Monero. Это означает, что для того, чтобы переместить Monero, обе стороны должны достигнуть соглашения. И это, очевидно, не будет атомным свопом, так как если один человек выйдет из сети, деньги сгорят. И тут в игру вступает скрипт Bitcoin, который заставляет получателя Bitcoin раскрыть свой приватный ключ. Когда приватный ключ будет раскрыт, другая сторона воспользуется схемой мультиподписи «2 из 2», и у неё уже будет два ключа, необходимых, чтобы потратить Monero по своему усмотрению.

Децентрализованные биржи, как правило, используют пороговые мультиподписи. Таким образом, при хранении средств они могут задействовать схему мультиподписи «t из n», а это означает, что средства в безопасности до тех пор, пока «t» подписантов честны. У вас может быть сотня узлов, но пока ваша пороговая подпись составлена честно, совершенно неважно, уйдут или нет остальные участники в офлайн, неважно, оставят они или нет криптовалюту, не имеет значения, будут ли они удалены - при всём том, что сейчас происходит с Ethereum, сеть по-прежнему существует, и кошелёк работает. Таким образом, безопасность и децентрализация средств напрямую связаны с сетью, непосредственно стоящей за децентрализованной биржей.

Именно поэтому я очень хотел показать несколько иные слайды, потому что сейчас будут представлены некоторые математические выкладки, которые могут слегка смутить. Но, если честно, эти слайды предназначены для скачивания и последующего использования. В данном случае единственно важными являются последние два пункта - остальное можно и пропустить.

Поговорим о криптографии на эллиптических кривых. Это основа всех современных криптовалют. Monero использует кривую, известную как ed25519, то есть, используются приватные ключи, о которых, я уверен, вы знаете, и которые технически называются «скалярами» и представляют собой очень, очень большие числа. Также существуют публичные ключи, технически известные как «точки». Публичные ключи можно складывать и вычитать, а также умножать на приватные ключи. Но их нельзя делить, поэтому вы не сможете вывести приватный ключ из публичного. Их также нельзя умножать на другие публичные ключи. Приватный ключ преобразуется в публичный путём умножения на базовую точку G. Таким образом, мы имеем не просто публичный ключ со значением 1, но мы берём точку G и говорим: «Давайте использовать её как единицу». Так мы получаем публичный ключ. Таким образом, если вы возьмёте свой приватный ключ X и умножите его на G, то получите публичный ключ. Обычно он обозначается как заглавная X. Обозначенные заглавной буквой единицы ― это точки. И здесь мы подходим к самому интересному. Именно эту часть важно понимать.

Если сложить два публичных ключа, то получится xG плюс yG. Так реализуется дистрибутивность. Если сложить два публичных ключа, мы получим то же значение, что и при сложении двух приватных ключей и последующем их преобразовании в публичный ключ. Это означает, что сложив приватные ключи всех пользователей, можно создать кошелёк с поддержкой схемы мультиподписи «n из n», а приватным ключом такого кошелька будет сумма всех приватных ключей. Сложение с одной стороны и сложение с другой стороны даёт одинаковый результат.

И сейчас мы переходим к тому, как это сделать правильно, поскольку сложение всех этих ключей может оказаться небезопасным. Описанная схема, простое суммирование, уязвима для так называемых «атак с подменой ключа». Допустим, Элис честно создаёт приватный ключ x с публичным ключом, обозначенным заглавной буквой X, а затем отправляет его Бобу. Боб создаёт приватный ключ y, но отправляет публичный ключ «Y – X». Таким образом, публичный ключ Элис X плюс публичный ключ Боба Y минус X аннулируются и получается Y, то есть, публичный ключ Боба теперь является публичным ключом мультиподписи, и он полностью контролирует её. Это было отмечено при реализации проекта, который какое-то время назад прошёл этап проверки концепции, и мною был составлен и отправлен соответствующий отчёт, чтобы убедиться, что проблема была исправлена.

В данном случае хитрость заключается в том, чтобы использовать безопасную агрегацию ключей, позволяющую предотвратить подобные атаки. Самый простой способ - потребовать от Боба доказать, что ему известен приватный ключ для того публичного ключа, который он предоставляет. Это называется «доказательством владения». Он опубликовал публичный ключ «Y – X», поэтому приватным ключом также должен быть «y – x». Ему известен y, потому что это его приватный ключ, но x - это приватный ключ Элис, который ему неизвестен. Поэтому он не может создать подпись и сказать: «Привет, я настоящий, я существую». И в случае с кошельком, поддерживающим схему мультиподписи, это вполне легитимный способ создания подписи.

Следующий вопрос - подпись. И это очередной слайд, который может немного ввести вас в замешательство. Здесь так же только последний пункт имеет значение. Я постарался сделать его понятным, хотя и включил сюда математические вычисления. Так что не волнуйтесь, если это не входит в область ваших знаний.

Простейшая возможная схема известна под названием «подпись Шнорра», и какое-то время она была запатентована... собственно, на этом и всё. Итак, обладая приватным ключом, который мы теперь обозначим как прописную a вместо заглавной X, ведь никто и никогда не договаривается об обозначениях, и выберем нонс r. Нонс генерируется случайным образом и может быть использован только один раз. Теперь берётся то, что необходимо подписать, обычно это сообщение, и в качестве публичного ключа также требуется хешировать нонс. Это называется «запросом». Затем вычисляется решение, которое представляет собой «нонс + запрос», умноженные на ваш приватный ключ, а сама подпись - это R и s. Не жду, что вы всё поймёте с первого раза, тем не менее...

Поскольку s должно быть равно «r + ca», вы можете умножить обе стороны на G, потому что r, умноженное на G - это заглавная R, которая является частью подписи. Также у нас имеется запрос, умноженный на приватный ключ, но когда вы умножаете его на G, он фактически записывается как строчная c, строчная буква для AG. Это эквивалентно c и заглавной A, поскольку заглавная A - это прописная a, умноженная на G, а R и A - публичный ключ. Затем, наконец, мы умножаем решение на G и выполняем проверку. Вам придётся потерпеть меня ещё минутку, потому что это важная часть. По сути, это уже следующий уровень.

Итак, любой может выбрать нонс и вычислить подпись, потому что мы включаем нонс в запрос ― вы получаете другое значение, и можно было бы получить s, умноженную на G, но нам нужна S, а не s, умноженная на G, что подразумевает невозможность подделки. И что важно, если вам известно значение r, нонс, вы сможете восстановить приватный ключ. Вот почему обработка нонса чрезвычайно сложна и должна выполняться с особой тщательностью. Также его нельзя использовать повторно, так как при повторном использовании можно произвести алгебраические вычисления, составить систему уравнений и восстановить его. И здесь мы возвращаемся к мультиподписям.

Данный протокол позволяет создавать подписи Шнорра за два раунда. То есть, что я отправляю сообщение, мне посылают сообщение в ответ - это первый раунд. Я делаю, что необходимо, отправляю другое сообщение, мне отправляют сообщение обратно - и это второй раунд. И если всё проходит успешно, я получаю подпись.

Каждый выбирает собственный нонс, и все используют его публичный ключ. А подпись - это просто сумма всех нонсов. Всем известен нонс, и подпись может принадлежать только им. Если каждому участнику известен используемый нонс, он может вычислить решение конкретно для своего нонса и своего приватного ключа, а затем просто сложить все решения. Это буквально обычное сложение. Это было придумано для использования в Bitcoin и планировалось к широкому внедрению.

Теперь поговорим о небезопасности мультиподписи. Это способ, который сейчас используется нами, и  который мы называем схемой мультиподписи. Он был взломан. Мы потратили на него два года, и это свидетельствует о том, что написать безопасный алгоритм мультиподписи очень непросто, ведь у нас на это ушло целых два года, и мы планировали использовать результат в Bitcoin.

Итак, способ был взломан в результате так называемой «атаки Дрейвера». Это уже относится к области криптографии, где существует так называемый «парадокс дня рождения», где вычисляется, насколько вероятно то, что, по крайней мере, у двух из n человек, находящихся в комнате, день рождения будет совпадать. И для наибольшей вероятности такого совпадения достаточно 23 человек. Так что, скорее всего, здесь есть несколько человек, у которых день рождения совпадает, что звучит несколько безумно - вы можете предположить, что для этого нужно 80 человек, но нет - только 23. И данный парадокс можно обобщить. Вместо того чтобы вычислять вероятность того, что у кого-то из присутствующих совпадает день рождения, мы можем прикинуть вероятность аннулирования набора хешей, вероятность того, что они будут иметь одно и то же значение. Точно так же, как если бы я задался вопросом, у кого совпадает день рождения, я запрашиваю эту хеш-функцию: «У кого тут одинаковые значения?». И это ведёт к конфликту, при котором имеются два разных значения хеш-функции с одним и тем же выходом.

Вагнер, если не ошибаюсь, в 70-х годах опубликовал эффективный алгоритм поиска решений для этого класса задач, а Дрейвер доказал, что он вполне применим к мультиподписям. Таким образом, при параллельном выполнении нескольких сеансов подписания злоумышленник может заставить группу подписать сообщение, о котором она даже не подозревала. Таким образом, для реализации такой атаки достаточно всего девяти параллельных сеансов подписания. Даже не 23.

Итак, точная схема этого сообщения, а мы вычисляем вызов, является суммой n других честных запросов. И дело в том, что другие честные запросы - это то, чем вы подписываетесь при наличии легитимных условий, но в подобной ситуации публичный ключ - это публичный ключ, и вы ничего не можете сделать с сообщением - для этого все должны договориться - вы не можете изменить этого. Но что касается нонса, это та часть ключа, которую вносите вы, и даже малейшего изменения достаточно, чтобы вычислить новый хеш. И это все, что вам нужно, чтобы начать поиск не одного конкретного нонса, который является конфликтным или вызывает конфликт хешей, а серии из девяти различных хешей, которые вам также необходимы.

Собственно, это и привело к появлению второй схемы мультиподписи. Через год после того, как Дрейвер с соавторами опубликовал свою работу, была опубликована вторая схема мультиподписи. Согласно ей, вместо того чтобы использовать один нонс, публикуются два нонса, R1 и R2, а затем добавляется «связующий коэффициент». Мы хешируем все нонсы с подписываемым сообщением. Таким образом, мы вычисляем количество нонсов R1 плюс R2, умноженное на связующий коэффициент. И это важно, поскольку, хешируя выбранные нонсы для получения коэффициента для фактического нонса, злоумышленник не сможет ими манипулировать. Если вы измените нонс, вы измените и то, что хешируется, и измените фактическое используемое значение. В итоге придётся повторно производить все вычисления. И этот цикл невозможно как-либо обойти.

И как всё это связано с Monero? Я говорил о математике, говорил о подписи Шнорра, говорил о Bitcoin, а теперь пора упомянуть и Monero. Используемый сегодня для создания кольцевых подписей алгоритм создаёт множество подписей, подобных подписи Шнорра. Поэтому все эти концепции, алгоритмы применимы к Monero и абсолютно точно пригодны для использования. Однако Monero привносит и свои сложности, поскольку это приватная монета. Да, мы любим усложнять себе жизнь, и поэтому у нас нет платёжных каналов. И одно из осложнений известно как «баг сжигания». Пожалуй, на данный момент это является для меня чем-то вроде личного крестового похода.

Теоретически, каждый выход ― это уникальный публичный ключ. Нам они известны как скрытые адреса, одноразовые ключи и так далее, и тому подобное. В случае Monero, когда вы тратите вход, вы не можете просто сказать: «Вот, это публичный ключ, и я его трачу». Это означало бы отмену приватности траты выхода. Поэтому вместо этого мы предоставляем образ ключа, а образ ключа эквивалентен данному публичному ключу, и мы можем произвести математические вычисления, чтобы доказать это. Но мы не говорим точно, что представляет собой настоящий публичный ключ. Отдельно взятый публичный ключ может иметь только один образ, что является защитой от двойной траты.

Даже несмотря на то, что ключи в ваших выходах должны быть уникальными, а они все должны быть уникальными, злоумышленник может воспрепятствовать этому. Но поскольку все они имеют один и тот же образ ключа, а блокчейн допускает наличие только одного образа ключа, даже если они относятся к одинаковым публичным ключам, только один из них может быть потрачен. Из-за этого все остальные ключи сгорают, потому что, потратив один, вы тратите все, даже если получаете средства только по одному из них. И такая схема была реализована несколько лет назад, в 2017 году, по-моему. По сути, об этом было написано на Reddit, когда мы подумали: «Так, нам придётся с этим разбираться!». К счастью, теперь в Monero эта проблема уже давно решена, и никого из вас она не беспокоит.

И теперь мы переходим к «багу сжигания» в контексте мультиподписи. При использовании мультиподписи в Monero есть лидер, который присваивает различные значения, взятые из Bulletproofs для ключей, связанных с выходами. То есть, Monero просто случайным образом выбирает одного человека, который будет генерировать все случайные данные, и с этого всё начинается. Однако такой лидер может повторно использовать ключ, связанный с выходом, поскольку он его и выбирает. Это может привести к сжиганию всех средств в мультиподписи, поскольку фактически их нельзя будет потратить. Вот вам и совершенно безопасный алгоритм мультиподписи.

И как предотвратить эти атаки? Согласно принятой практике, требуется минимизировать объём данных, контролируемых одним участником. Мы также уменьшаем объём пересылаемых данных, потому что если участник может локально создать значение, то пусть так и делает. Я не должен доверять созданному вами значению XYZ, если могу создать его сам. Все мы здесь выступаем за отсутствие доверенных настроек. И, наконец, если значение должно быть уникальным, например, значение ключа, связанного с выходом, они должны создаваться с уникальными значениями. В Monero образы ключей могут быть использоваться лишь единожды, поэтому если мы хешируем один из них для получения ключа, связанного с выходом, мы гарантированно получим уникальные ключи, если только кому-то не удастся взломать нашу хеш-функцию, что создаст уже несколько других проблем.

Так, для исправления «бага сжигания» в мультиподписи определение ключей, связанных с выходами, было заменено на выходы хеш-функции, где энтропия обеспечивается лидером. Таким образом, по-прежнему всё выбирается случайным образом, по-прежнему обеспечивается приватность, но теперь есть ещё и соответствующая хеш-функция для образов ключей, чтобы гарантировать их уникальность. Благодаря тому, что все стороны локально генерируют фактические ключи, связанные с выходами, минимизируется объём передаваемых данных, снижается уровень загрузки канала связи, а также обеспечивается правильность. Сведение функций лидера к обеспечению энтропии означает, что им нельзя манипулировать, но тот факт, что он всё же отвечает за обеспечение некоторой случайности, сохраняет приватность. И, как я уже сказал, хеш-функция заполняется образами ключей, что обеспечивает уникальность исходящих ключей.

И теперь можно поговорить о том, на каком этапе мы сейчас находимся, ведь тема мультиподписей уже давно обсуждается в Monero и по-прежнему является актуальной в силу небезопасности схемы. Если вы уже сегодня используете мультиподписи в Monero, то вам не следует этого делать. Мы открыто говорили об этом, и я повторяю это снова. Существует пулл-реквест, опубликованный perfect-daemon и UkoeHB, в котором предлагается схема биномиального нонса, и в какой-то момент в него было внесено исправление для вышеупомянутой проблемы, но оно было перенесено в другой реквест. Исправление было всесторонне проанализировано, чтобы убедиться в том, что оно было реализовано верно ― мы не хотим вновь подвергать сообщество риску, поскольку существующая схема мультиподписи не работает, она ошибочна. А мы не хотим допускать подобных ошибок. Мы работаем для того, чтобы построить финансовую систему будущего, в которой бы обеспечивалась приватность пользователей, а вовсе не для того, чтобы в какой-то момент обнаружить, что все наши деньги куда-то пропали. И, к счастью, всё это относится только к мультиподписи, которая используется нечасто. Так что, мы работаем над тем, чтобы такое больше не повторилось. Сейчас схема проходит аудит, проводимый компанией RINO, и результаты, я думаю, будут готовы уже через несколько дней. По крайней мере, для первоначальной версии.

И немного о будущем схемы мультиподписи, о том, что произойдёт после того, как мы её исправим. Сейчас Monero использует довольно специфический алгоритм, который я не стал описывать, потому что это заняло бы час или два, но он оптимизирован для использования с пороговой подписью, построенной по схеме «n – 1». Это означает, что вы создаёте  мультиподпись по схеме «2 из 3», как это происходит в случае с Haveno и в случае со схемами группового восстановления. В Monero для создания мультиподписи используется собственный алгоритм генерации ключей. Но он слишком медленный для большинства вариантов практического применения. Если вы хотите создать децентрализованную биржу, где в создании подписи участвовал бы 21 человек из 30, то этот алгоритм не сработает, поскольку содержит несколько ошибок.

Кроме того, существует схема FROST, которая разрабатывалась параллельно со второй схемой мультиподписи, и требует такой же доработки. Тем не менее, схема предполагает создание подписи с порогом «t из n», а не «n из n», где подписаться должен каждый. Также схема использует тот же протокол с проведением двух раундов, который очень эффективен, и сторонником которого я являюсь на данный момент.

Ну и заключительные комментарии. Я убеждён, что мультиподпись очень важна не только с точки зрения безопасности, не только с точки зрения избыточности, но и для расширения возможностей использования Monero. Нам очень нравится второй уровень, мы являемся сторонниками децентрализованных бирж, у нас есть команда Farcaster, реализующая концепцию атомных свопов, и схема мультиподписи стоит над всем этим. Кроме того, я создал библиотеку мультиподписи на базе FROST для Monero и опубликовал её незадолго до выступления. Если кто-то захочет заглянуть на GitHub и посмотреть, что там есть, я с удовольствием поделюсь ссылкой. Но пока не используйте её. Она даже не прошла рецензирования. Несколько месяцев назад она была проанализирована в частном порядке. Так что, пожалуйста, пока не пользуйтесь ею. Я не несу за это ответственности. Но если вы разработчик Rust, заинтересованный в подобной работе, свяжитесь со мной, и я с удовольствием включу вас в работу.

Теперь, если у нас осталось время, вы можете задать свои вопросы. Но я не уверен, осталось ли у нас время.

_**Вопрос из зала:**_ Наверняка, это будет глупый вопрос, но если лидер в одном из раундов создания мультиподписи задействует вредоносный код, он уже не сможет воспользоваться «багом сжигания»?.

_**Люк:**_ Исправление «бага сжигания» исключает эту возможность. Первоначально исходные ключи предоставлялись напрямую, но теперь это хеш-функция, использующая образы ключей. Какой бы умысел не имел лидер, он не сможет изменить политику Monero в отношении двойных трат, и он не сможет изменить образы для тех ключей, которые у него имеются, поскольку изменённые образы не позволят сгенерировать такие ключи.

_**Вопрос из зала:**_ Отлично, спасибо.

_**Люк:**_ Спасибо.

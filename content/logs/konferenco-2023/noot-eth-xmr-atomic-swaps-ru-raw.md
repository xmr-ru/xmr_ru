---
title: "Элизабет 'noot' Бинкс - Атомарные свопы ETH-XMR"
date: "2023-06-24"
categories:
  - "Стенограмма"
tags:
  - "Monerotopia 2022"
lead: "Monero Konferenco 2023 #MoneroKon2023 Прага - День 2"
pager: true
toc: false
sidebar: "right"
---

{{< youtube id="f3Yrc_Agg84" autoplay="false" >}}

---

_**Элизабет:**_ Спасибо, что пришли. Меня зовут Элизабет. Сегодня я буду говорить об атомных свопах ETH-Monero. И сначала немного о себе. Я занимаюсь разработкой программного обеспечения, работаю над реализацией атомных свопов ETH-Monero уже около полутора лет. А в целом я занимаюсь разработкой протоколов уровня блокчейна уже в течение пяти лет или около того.

Сегодня я расскажу о текущем состоянии протокола совершения свопов, кратко об архитектуре, немного о том, как его использовать, и если останется время, о планах на будущее.

Итак, немного предыстории атомных свопов. По сути, это не требующий доверия способ p2p обмена двумя чистыми активами между разными блокчейнами. В данном случае речь идёт об ETH и Monero. А «атомный» означает, что либо обмен проходит успешно, и обе стороны получают те средства, которые хотят получить, либо получают собственные средства обратно. И это криптографически гарантируется протоколом.

Немного о том, что было сделано в последнее время. Протокол был реализован в основной сети уже около двух месяцев назад. Ура! Именно так. Поэтому не стесняйтесь, пробуйте, пользуйтесь им. Я дам ссылку на GitHub и прочие ресурсы в следующих слайдах.

Какой слайд у меня на очереди? Да, я выражаю огромную благодарность сообществу за финансирование в системе CCS, а также фонду MAGIC за организацию и помощь во втором раунде финансирования. Также спасибо всем контрибьюторам кодовой базы и всем тем, кто пытался сделать с ней что-то всё это время.

Далее. о том, как выглядит архитектура, я расскажу подробней чуть позже. А сначала о том, как, собственно, работает протокол. Пожалуй, это будет самая техническая часть моего выступления.

Допустим, у нас есть две стороны, Элис и Боб. У Элис есть ETH и она хочет получить Monero, а у Боба есть Monero и он хочет получить ETH. Протокол свопа предполагает наличие p2p-сети, и Боб размещает своё предложение в этой p2p-сети, после чего Элис сможет найти его. Это особенность конкретно этого варианта реализации. Вы можете использовать другие механизмы поиска предложений. Например, веб-сайт или что-то подобное. Затем Элис принимает предложение, и запускается сам своп. У каждой стороны есть секретное значение. У Элис это значение x_a, а у Боба - x_b.

Рассмотрим успешный вариант проведения свопа. Надеюсь, всё достаточно хорошо видно. Для успешного совершения свопа в начале Элис должна заблокировать ETH, поэтому в Ethereum размещается смарт-контракт, в котором Элис блокирует ETH. Также на данном этапе блокировки Элис размещает обязательства по двум секретным значениям в указанном контракте. После этого Боб видит блокировку и подтверждает, что обязательства верны, значения верны, а затем блокирует Monero на счёте в блокчейне Monero, где закрытый ключ - это сумма двух секретных значений. Прошу прощения, мне следовало бы исправить обозначения. В общем, это сумма двух секретных значений. Затем, на этом этапе, Боб или Элис видят блокировку Monero, и при этом ей известно, по какому адресу будет заблокирована сумма. Тогда она вызывает функцию в контракте, которая определяет, что теперь Боб может в соответствии с контрактом может запросить средства. Но если Элис по какой-то причине не увидит блокировку или уйдёт в офлайн, то будет установлен тайм-аут, который сработает автоматически и позволит Бобу сделать запрос. И как только контракт будет готов, Боб просто вызовет функцию запроса в контракте, входным параметром которой будет секретное значение свопа. И когда он введёт его, функция просто переведет ему средства. Это, по сути, атомная часть. Итак, когда Боб раскроет свою часть секретного значения свопа, Элис узнает закрытый ключ счёта, на котором были заблокированы Monero, и сможет делать с ними всё, что захочет. Вот, собственно, и вся атомная часть.

И существует два возможных пути возврата средств на тот случай, если что-то пойдёт не так. Например, кто-то уйдёт в оффлайн, поскольку на протяжении всего времени свопа обе стороны должны оставаться в сети.

Итак, первый путь возврата сводится к тому, что если Элис блокирует ETH, а Боб уходит в офлайн, не блокируя Monero, как я уже говорила, в контракте есть тайм-аут, и когда по истечении этого первого тайм-аута Боб может автоматически сделать запрос. Поэтому Элис будет ждать, пока время этого тайм-аута не истечёт. А затем, если Monero не будут заблокированы, а время тайм-аута подойдёт к концу приближается, она просто вызовет функцию в контракте, которая вернёт её ETH. Эта функция возврата похожа на функцию запроса, так как в ней используется секретное значение свопа Элис. Так что в случае, если по какой-то причине Боб заблокируется, но Элис об этом знать не будет, Боб точно так же всё равно сможет вернуть свои средства.

И второй путь возврата средств. В данном случае Боб по какой-то причине не запрашивает ETH. Итак, первый шаг такой же, как и при успешном проведении свопа. Обе стороны успешно блокируют свои средства, после чего контракт становится готовым, но затем Боб по какой-то причине не запрашивает средства. Для этого и существует второй тайм-аут, по истечении которого единственным возможным ходом становится возврат средств Элис, чтобы Боб не смог запросить их. Таким образом, Элис будет просто наблюдать за контрактом и, увидев, что до окончания второго тайм-аута ничего не произошло, вызовет функцию возврата, как в случае с передачей своего секретного значения свопа. А затем, например, из-за того, что Боб ушёл в оффлайн или чего-то подобного, она сожжет вернуться в сеть и проверить контракт, увидеть транзакцию возврата, узнать главное секретное значение и вернуть себе Monero, который были заблокированы.

Вот, собственно, и весь протокол. Более подробную документацию найти на GitHub, а также задав мне вопросы после выступления.

Теперь немного о нашем пути в основною сеть, немного о том, что уже было реализовано, о фактической реализации. Сам протокол относительно прост в реализации. Но при его непосредственном внедрения приходится учитывать гораздо больше нюансов. Например, если кто-то остановит узел свопа в середине процесса или что-то в этом роде. Как можно будет всё восстановить, и как вы узнаете, на каком этапе находился процесс? Как убедиться, что секретное значение свопа не было потеряно или не случилось что-то подобное?

Прежде всего, это безопасность базы данных и перезагрузки. По сути, требуется, чтобы в случае отключения узла в любой момент пользователь мог восстановить все данные.

Также была встроена функция обработки транзакций кошельком Monero. В первой итерации вам приходилось запускать CLI кошелька Monero отдельно, но это было немного неудобно. Теперь функция встроена. Кошелёк всё сам сделает всё необходимое после запуска, а затем в конце автоматически отправит средства туда, куда вам нужно.

Также была реализована система ретрансляции. Из-за того, как работает Ethereum, при проведении каждой транзакции приходится платить. Но, допустим, если вы Боб, и у вас нет ETH, и вы только собираетесь получить его, как вам расплатиться за газ? Система ретрансляции решает эту проблему. По сути, вы поручаете кому-то другому оплатить газ за вас, а в обмен человек получает небольшую часть средств из свопа.

Кроме того, мы реализовали поддержку ERC20, поддержку токенов. Ну и в целом были исправлен ряд ошибок, улучшен пользовательский интерфейс, проведено тестирование, а также добавлена специальная программа для загрузочных узлов. Об этом я расскажу чуть позже, и это будет интересно непосредственно для участников p2p-сети.

Итак, немного о p2p-сети. Программа использует библиотеку libp2p, которая является простой библиотекой одноранговой сети. Она имеет уйму уже встроенных полезных функций. Если вы используете NAT, теперь у вас есть возможность работы с NAT. Сеть поддерживает DHT для обнаружения пиров. Это полностью одноранговая децентрализованная общедоступная сеть. Вы можете просто запустить узел и присоединиться к ней, и такие вещи, как обнаружение предложений, также происходят децентрализовано.

Затем, и я уже говорила об этом, всё, что касается безопасности базы данных и перезапуска, всей необходимой информации - она теперь хранится на диске. Так что если что-то случится во время свопа, вы сможете безопасно перезапустить его.

И ещё немного о системе ретрансляции. Ещё один из её преимуществ заключается в том, что она снижается отрицательный эффект на приватность, когда вам приходится выводить ETH на счёт, который уже использовался или где уже имеется ETH. Так что система ретрансляции является хорошим усовершенствованием как с точки зрения приватности, так и пользовательского взаимодействия. Ретрансляторы предлагают свои услуги в p2p-сети подобно тому, как это делают люди, размещающие свои предложения по совершению свопов. Взамен они получают часть средств из свопа.

Так что если вам нужен ретранслятор, вы можете воспользоваться программой, которая автоматически найдёт его для вас в p2p-сети. Это работает следующим образом: Боб подписывает транзакцию, транзакцию запроса, а затем ретранслятор отправляет её от своего имени и оплачивает газ. После этого другая сторона проверяет подпись, совершает прочие необходимые действия, а затем переводит большую часть средств Бобу и немного ретранслятору в качестве комиссии. После этого можно выводить средства на новый счёт, что очень удобно.

То есть, всё происходит практически так же, как при успешном варианте проведения свопа, за исключением той части, где Боб делает запрос. Да, он будет искать ретрансляторов. Допустим, найдёт ретранслятора по имени Чарли. После этого Чарли должен будет отправить свой адрес для получения платы за услуги ретранслятора. А затем Боб подпишет данные запроса, включающие в себя этот адрес для выплаты. По сути, это предотвращает вероятность фронтраннинга. Я обнаружила это во время тестирования, и с этим было очень интересно поработать. Так что, это ещё и защита от фронтраннинга.

Но ретрансляторы необходимы не только маркетмейкерам, но и системе в целом. При их отсутствии, полагаю, она станет просто неудобной в использовании. Сейчас она общедоступна, и ей могут пользоваться все присоединившиеся. Я бы настоятельно рекомендовала сделать это, поскольку для этого не требуется, чтобы у вас были в наличии Monero. Вам нужно лишь очень небольшое количество ETH, чтобы для начала оплатить газ. И уже только за это вы получите немного средств. Так что я бы рекомендовала заняться этим.

Далее, мы прошли два варианта реализации протокола. Изначально мы выбрали вариант, совместимый с мета-транзакциями, но многие из них написаны на JavaScript. Мне это не понравилось, потому что код написан на Go. В итоге я реализовала нашу собственную небольшую систему, которая намного чище. Но в будущем, возможно, перейдём на стандарт EIP4337, обеспечивающий абстракцию аккаунтов, своего рода стандартизированную систему ретрансляции. Но на момент запуска она ещё не была готова, так что, возможно, это будет сделано в будущем.

И последний, или один из последних аспектов - загрузочные узлы, используемые в качестве точки входа в p2p-сеть. В каждой p2p-сети должны использоваться жёстко закодированные адреса, к которым узел будет подключаться при запуске, чтобы войти в сеть. Иначе вы просто не сможете войти. Такие узлы должны быть общеизвестными или жёстко закодированными. Кроме того, запуск загрузочных узлов категорически приветствуется. Для этого не нужно иметь никаких средств. Вам не нужно ничего делать. Вы просто запускаете узел, который способствует децентрализации системы, ведь чем больше загрузочных узлов, тем лучше, на тот случай, если какой-нибудь из них выйдет из строя. Так что если вы хотите внести свой вклад, но не хотите совершать никаких свопов, вы также можете запустить загрузочный узел.

А теперь несколько часто задаваемых вопросов. Первый из них - может ли своп работать с какими-либо блокчейнами, кроме Ethereum? Ответ - да. Протокол может быть развёрнут в любом блокчейне EVM. Как уже было сказано, здесь используется смарт-контракт, и протокол развёртывается в любом блокчейном EVM как есть. Но даже, если вы хотите развернуть протокол в блокчейне, не являющемся EVM, вы можете переписать контракт на любом языке смарт-контрактов, поддерживаемом этим блокчейном. В настоящее время существует только реализация для ETH, но теоретически вы можете развернуть протокол в любом блокчейне, поддерживающем смарт-контракты с одной стороны, и Monero с другой.

И ещё один вопрос: почему только держатели Monero могут быть маркетмейкерами? Как вы, возможно, помните, как было мной продемонстрировано, на первом этапе протокола требуется, чтобы держатель ETH сначала заблокировал свои средства. Так почему же существует такое одностороннее ограничение? По сути, в Monero нет возможности возврата средств. В этом и заключается основная проблема. Это и заставляет владельцев ETH делать первый шаг, поскольку если владелец Monero сделает его, а затем заблокирует средства, а держатель ETH так ничего и не сделает, как они смогут вернуть деньги? Никак. Поэтому согласно протоколу держатель ETH делает первый шаг.

Однако, если, допустим, держатель ETH является маркетмейкером, то есть публикует в сети предложения, которые можно принять, он может попасть в неприятную ситуацию. То есть, поскольку он делает первый шаг и у него есть предложение, кто-то может принять его, заблокировать средства, а затем вернуть деньги, просто ничего не сделав. И тогда владелец ETH потеряет кучу газа, потратив его на все эти действия, и понесёт траты. кто-то может сделать это, даже не имея ничего на кону, потому что обладатель ETH ходит первым.

Так что на данный момент это своего рода одностороннее ограничение. Только владельцы Monero могут публиковать предложения в сети. Но я надеюсь, найдутся способы решения этой проблемы. Это уже предмет исследования. Вот, примерно так. А если у вас есть ещё какие-нибудь вопросы, пожалуйста, задайте их после выступления. Но надеюсь, что всё объяснила.

Так, думаю, у меня хватит времени, поэтому я покажу, как собственно происходит своп. Пока это только вариант с использованием командной строки. Так что если вы привыкли работать с ней, это даже хорошо. Мы постарались сделать всё предельно простым в использовании, чтобы было проблематично запутаться. Так что даже если вы не знакомы с командной строкой, я рекомендую попробовать.

Сначала вы просто запускаете сборку, затем запускаете двоичный файл swapd, и попадаете в конечную точку Ethereum. Таким образом, вы можете запустить свой собственный узел, а эти люди будут удалёнными конечными точками. То есть так это всё запускается, после чего происходит автоматическое подключение к основной сети.

Кроме того, вы можете проверить свой баланс. На узле свопа хранятся приватный ключ ETH, приватный ключ Monero хранится в кошельке, и так вы можете проверить свой баланс. Вы также можете легко пополнить счёт. Здесь есть QR-код, что очень удобно. Так вы можете пополнить счёт. А также есть команды для вывода средств, так что по сути это целый кошелек в программе.

Итак, если вы захотите произвести своп, или, простите, если вы захотите опубликовать предложение, вы можете использовать команду swapcli make, и ввести ваши параметры, то есть то, сколько вы хотите выставить в качестве предложения. Вы можете установить курс обмена, который программа берёт у оракула. Разумеется, его стоит проверить дважды, но он там есть.

После того как вы опубликовали предложение, вы увидите ID предложения и подобную информацию. А чтобы найти предложения, имеющиеся в сети, требуется ввести команду swapcli get-offers, которая выведет эти предложения. И как только вы найдёте подходящее, вы можете... так, это тоже вроде предложение... ой, простите, это для получения просмотра предложений. А это - для поиска предложений в сети. Таким образом, эта команда показывает вам предложения. И когда вы выберете одно из них, вы можете просто принять его, а затем ввести ID предложения, ID пира, который является удалённым узлом, p2p ID, а затем сумму, которую вы собираетесь предоставить в ETH, после чего начнётся своп.  Вы также можете проверить текущие свопы. Это была только текущая команда. Также с помощью команды past вы можете проверить свои прошлые свопы. Вот, в общем-то, на этом и всё.

Я не стала описывать всё подробно, потому что не думала, что мне хватит времени. Но если вы посмотрите моё выступление на Monerotopia в прошлом месяце, то сможете увидеть, как это работает на практике.

А теперь немного о планах  на будущее. Одна из вещей, которую определённо хотелось бы добавить, - встроенный механизм обеспечения приватности в сети. Как уже говорилось, протокол использует библиотеку p2p, но пока что у нас нет хорошего встроенного транспорта для обеспечения приватности. В идеале мы бы хотели обеспечить её посредством Tor или Nym или чего-то подобного.

Динамическое ценообразование для ретрансляторов. Сейчас расценки, как и размер вознаграждения, получаемого при ретрансляции фиксированы. Но если цена на газ сильно подскочит, будет плохо, поскольку вы не получите достаточной комиссии в силу подорожания газа. Поэтому возникает вопрос динамики. Да, в последнее время цена на газ не меняется, но в случае, если она повысится, хотелось бы, чтобы и комиссия за ретрансляцию тоже росла.

Далее - браузерный пользовательский интерфейс. Сейчас вы можете запустить что-то вроде пользовательского интерфейса на собственном хосте. Он работает не очень хорошо, но просто сейчас им занимаются не так усиленно. Но нам бы хотелось реализовать браузерный пользовательский интерфейс, который можно было бы запускать либо локально, либо, даже не знаю... В идеале, его не нужно запускать локально, но это гораздо сложнее. Поэтому пока для проведения свопа можно было бы использовать MetaMask, браузерный кошелёк или что-то подобное. Таким образом, вам не нужно вносить средства в CLI, а можно просто использовать обычный браузерный кошелёк. Далее следуют тестирование, исправление ошибок, удобство использования и всё такое прочее.

В общем, всё готово к использованию. Нам нужны провайдеры Monero. Нам нужны провайдеры ликвидности, и если вы хотите ими стать, обязательно свяжитесь с нами. Нам нужны ретрансляторы, и больше загрузочных узлов также не помешало бы. Это ссылка на GitHub - AthanorLabs / atomic-swap. Ещё у нас есть комната в Matrix - ethxmrswap. Так что, если загляните на GitHub, вы сможете связаться с нами. На этом у меня всё.

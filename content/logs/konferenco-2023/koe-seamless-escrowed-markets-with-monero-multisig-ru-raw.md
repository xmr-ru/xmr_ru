---
title: "koe - Бесшовная организация эскроу-торговли с помощью схемы мультиподписи Monero"
date: "2023-06-23"
categories:
  - "Стенограмма"
tags:
  - "Monerotopia 2022"
lead: "Monero Konferenco 2023 #MoneroKon2023 Прага - День 2"
pager: true
toc: false
sidebar: "right"
---

{{< youtube id="A-fb7XmkMOw" autoplay="false" >}}

---

_**koe:**_ Привет всем! Я расскажу о том, как мы можем организовать эскроу-торговлю с помощью схемы мультиподписи Monero. Это можно сделать, даже воспользовавшись уже существующей схемы мультиподписи Monero, но я буду говорить о более эффективной версии, которая является, как я её называю, "бесшовной".

И прежде всего мы поговорим о том, как на данный момент, или как в принципе работает схема мультиподписи Monero. Мультиподпись - это технология, используя которую несколько человек могут совместно создать кошелёк Monero, в результате чего члены такой группы будут совместно владеть средствами. Мы называем это схемой "M-из-N", когда при наличии группы, в которую входит N пользователей, например, три человека, и при значении M равном двум, для совершения любой транзакции, расходования средств, требуется два человека из трёх.

Чтобы создать аккаунт по схеме мультиподписи, все члены группы начинают с набора базовых ключей. То есть, существует основная пара базовых ключей, которая инициализирует компонент мультиподписи. Также есть общая пара базовых ключей, которая объединяется в общий закрытый ключ мультиподписи, представляющий собой хэш составляющих его закрытых ключей участников группы. И этот общий закрытый ключ используется в качестве закрытого ключа просмотра группы участников мультиподписи, так что все члены группы имеют один и тот же ключ просмотра. А затем этот закрытый ключ можно использовать для подписания сообщений в качестве участника группы.

Кроме того, у всех членов группы имеется свой личный подписывающий ключ, используемый в качестве идентификатора члена группы и необходимый для подписания всех сообщений, созданных данным участником группы. Такие подписи необходимы для надлежащей валидации сообщений, передаваемых между участниками группы.

Чтобы создать аккаунт по схеме мультиподписи, мы используем алгоритм обмена ключами на базе алгоритма Диффи-Хеллмана. Сначала участники группы отправляют все свои открытые ключи из основной пары ключей, а также закрытые ключи общей пары ключей всем остальным членам группы. Общие закрытые ключи сразу же объединяются в общий закрытый ключ группы участников мультиподписи, но основные открытые ключи используются для обмена по алгоритму Диффи-Хеллмана. Таким образом, каждый участник группы использует свою пару основных ключей для обмена по алгоритму Диффи-Хеллмана всеми основными открытыми ключами других участников группы. Таким образом, создаются общие секреты для каждой пары участников группы.

Теперь, когда мы проходим промежуточный раунд, эти секреты Диффи-Хеллмана напрямую отправляются всем остальным участникам группы. А затем в следующем раунде по алгоритму Диффи-Хеллмана происходит ещё один обмен этими парами ключей, полученными в предыдущих раундах. В итоге каждый уникальный создаваемый ключ будет иметься у всех трёх участников, обеспечивающих компоненты для создания секретов по алгоритму Диффи-Хеллмана. И так продолжается до тех пор, пока в секретах, создаваемых по алгоритму Диффи-Хеллмана, не наберётся достаточное количество участников. Как только это произойдёт, вместо обмена секретами Диффи-Хеллмана, произойдёт их хэширование. Это происходит в последнем раунде - секреты хэшируются, умножаются на генератор мультиподписи или генератор ключей, генератор ключа, который вы хотите произвести. А затем полученные доли открытого ключа, компоненты ключа каждого подписанта, отправляются всем остальным подписантам. После этого все доли ключей объединяются в полный открытый ключ мультиподписи.

То, что мы делаем в данном случае, называется агрегацией ключей, и для этого у нас есть уравнение. Мы не складываем их напрямую. Сначала мы умножаем их на коэффициент, гарантирующий, что вы не сможете произвести так называемую отмену ключа, что нарушило бы инвариантность мультиподписи. И, конечно, у нас есть общий открытый ключ, который, по сути, является общим закрытым ключом, умноженным на генератор.

Важное замечание, связанное с безопасностью процесса обмена ключами - после обмена ключами необходим раунд проверки, в рамках которого вы получаете копию полного открытого ключа от всех остальных участников группы. А затем вы требуете, чтобы у всех остальных участников группы был точно такой же окончательный полный открытый ключ. Это необходимо, поскольку в том случае, если вы не проверите наличие полного открытого ключа у всех остальных участников группы, то, возможно, один из них будет заблокирован злоумышленником из состава группы, и мультиподпись построена не будет, а следовательно, предполагаемый размер группы по факту уменьшится. То есть, вы не сможете создать подпись без участия такого злоумышленника, по сути, заблокировавшего остальных подписантов.

И я придумал несколько вариантов оптимизации этого процесса, которыми можно воспользоваться, если надлежащим образом убедиться в том, что при их использовании инвариантность не будет нарушена. То есть, как написано внизу:  "использовать с осторожностью".

Итак, один из вариантов оптимизации - принудительное обновление одного из раундов обмена ключами. С его помощью вы можете завершить раунд, не получая сообщений от всех подписантов. Как правило при обмене по алгоритму Диффи-Хеллмана, в рамках которого несколько человек обладают компонентами секрета, как правило, вы ожидаете получения рекомендаций от каждого из них. Таким образом, вы получаете рекомендации для данной копии доли ключа от каждого из участников, а затем проверяете, чтобы все они имели одинаковые рекомендации. Это необходимо для поддержания инвариантности процесса обмена ключами. Но при принудительном обновлении мы можем потребовать, чтобы только один или несколько обладателей секрета рекомендовали ключ.

Вторая вариант оптимизации - так называемый "бустинг раунда". То есть, это когда у нас есть, скажем, один человек, и ещё два человека, и, допустим, этот человек получает от двух других сообщения из предыдущего раунда обмена ключами и немедленно обновляет свой кэш до следующего раунда, не дожидаясь или не следя за тем, чтобы другие участники также синхронно обновили свои аккаунты. Таким образом, по сути, другие участники создают неполные сообщения следующего раунда, которые этот подписант может использовать для продвижения в рамках протокола обмена ключами.

Если эти варианты оптимизации использовать неправильно, в итоге можно подвергнуться атаке с захватом ключа, когда злоумышленник будет участвовать во всех подписях. Или же это может привести к заморозке аккаунта. Например, если вы принудительно обновите раунд верификации после обмена ключами, то, как я уже говорил, вы можете столкнуться с ситуацией, когда не все подписанты смогут принять участие в подписании. И я ещё вернусь к этим вариантам оптимизации в контексте эскроу-торговли и расскажу, как могут быть использованы эти сценарии.

Итак, при построении транзакции по схеме мультиподписи всё начинается с предложения по созданию транзакции от одного из участников группы. В предложении указывается количество подписантов, подмножество со значением M, то есть, то количество участников группы, которое будет участвовать в попытке построения транзакции. Также указываются входы и выходы транзакции, размер комиссии и любая дополнительная информация, которую вы хотели бы включить в транзакцию. Затем каждый из остальных участников может проверить этот протокол транзакции. Участники могут смоделировать транзакции. на основе информации, содержащейся в предложении, и таким образом проверить, может ли теоретически быть совершена такая транзакция. Кроме того, необходимо проверить, действительно ли участник владеет указанными входами транзакции, что они не связаны и не были потрачены. Также необходимо проверить, чтобы выходы, указанные в предложении, были приемлемы.

Далее, если вы хотите подписать транзакцию по схеме мультиподписи, требуется пройти церемонию подписания, которая состоит из трёх этапов. Во-первых, каждый участник инициализирует подпись, предоставляя нонсы для подписи. В рамках схемы мультиподписи каждый участник должен предоставить два нонса, что позволит избежать так называемой атаки Дрижвера, которая является довольно технической, но которую очень важно предотвратить. В противном случае в определённых ситуациях доли ключей других участников могут быть похищены. Затем, получив нонсы от всех других подписантов, входящих в состав подгруппы, вы отвечаете частичными подписями каждого из участников, а затем объединяете частичные подписи в полную. И, конечно, затем необходимо проверить, является ли полная подпись действительной.

В рамках библиотеки Seraphis, или работая над библиотекой Seraphis, я реализовал нечто вроде агрегируемой подписи, когда вы заранее согласовываете, какие доли ключей будут предоставлены каждым из участников группы. Таким образом, доли ключей будут дублироваться между всеми участниками группы, поскольку у подмножеств группы будут общие секреты. Поэтому необходимо координировать, кто из участников группы и какие общие секреты будет предоставлять. И мы это делаем, заранее зная, какая подгруппа будет участвовать в подписании. И мы предоставляем доли ключей только от самого младшего участника подгруппы с данной долей ключа.

Также в случае со схемой мультиподписи Monero при подписании транзакции подпись состоит из двух компонентов. Это компонент закрытого ключа, а также данные ключа просмотра. При этом данные ключа просмотра известны всем участникам группы, и компонент закрытого ключа распределяется между всеми участниками. Таким образом, подписание по схеме мультиподписи сводится к передаче закрытого ключа. Поэтому в случае такого подписания каждый из подписантов может просто предоставить частичные данные ключа просмотра, известного всем участникам группы.

Теперь, когда мы разобрались со всем этим, обсудим, как это можно применить в контексте организации эскроу-торговли, однако, с оговоркой, что всё, что будет сказано, носит экспериментальный характер, является неполным и, вероятно, небезопасным решением. Надеюсь, что всё-таки нет, но возможно.

Итак, в процессе эскроу-торговли участвуют три игрока: покупатель, который взаимодействует с продавцом какого-либо товара, и сторонний арбитр, разрешающий возможные споры между покупателем и продавцом. Поэтому в данном сценарии используется схема мультиподписи "2-из-3", где большую часть времени покупатель и продавец будут сотрудничать для передачи средств от покупателя к продавцу. То есть, покупатель предлагает продавцу создать мультиподпись.

Итак, в рамках схемы "2-из-3" нам необходимо создать аккаунт, и для этого у нас есть три раунда. Мы начинаем с базовых ключей. Все базовые ключи передаются другим участникам. Затем участники производят обмен ключами по алгоритму Диффи-Хеллмана, преобразуют их в открытые ключи для каждой пары, так что получается три набора, затем они отправляются всем остальным игрокам, а после ключи объединяются в полный открытый ключ. И, безусловно, эти открытые ключи должны быть переданы для верификации после обмена ключами.

Итак, нам нужно, чтобы покупатель обратился к продавцу, создал аккаунт по схеме мультиподписи, внёс средства на этот аккаунт, создал транзакцию для перевода средств с аккаунта на счёт продавца, и всё это за один шаг. Затем нам нужно, чтобы продавец получил эту информацию, отправил товар, начал подписывать транзакцию и отправил эту информацию покупателю, а затем, когда покупатель получит товар, он завершит транзакцию и отправит её в сеть. Нам не нужно, чтобы покупатель производил ещё какие-то шаги. Нам нужно, чтобы покупатель получил товар, заплатил и завершил сделку. И это те две вещи, которые мы хотим от покупателя.

Чтобы реализовать такой рабочий процесс, самое важное - свести действия покупателя к одному шагу. И для этого мы используем оба варианта оптимизации, о которых я говорил ранее.

Прежде всего, продавец сотрудничает с арбитром, поэтому на стадии подготовки оба они должны быть онлайн. Продавец и арбитр сотрудничают для создания базовых ключей и сообщений второго раунда бустинга. Таким образом, цель второго раунда состоит в том, чтобы в результате обмена каждой парой по алгоритму Диффи-Хеллмана продавец и арбитр создали открытые ключи Диффи-Хеллмана, которыми бы они обменялись между собой, но не с покупателем, которого пока не существует. Таким образом, это спекулятивная стадия настройки для продавца и арбитра.

Итак, мы называем второй раунд раундом бустинга, поскольку созданное во втором раунде сообщение является неполным. Оно не содержит открытых ключей Диффи-Хеллмана передаваемых между продавцом и покупателем, например. Таким образом, предварительная информация готовится продавцом и публикуется вместе с предложением товара. И тогда покупатель получает базовые ключи, сообщения второго раунда бустинга и предложение продукта, что позволяет ему завершить настройку аккаунта за один шаг. Он использует базовые ключи, предоставленные продавцом, использует сообщения второго раунда, которые являются неполными для ускоренного завершения второго раунда, а затем покупатель принудительно обновляет раунд валидации, следующий за обменом ключами. Позже я обосную использование такой оптимизации.

Однако для того, чтобы всё было безопасно, покупатель должен каким-то образом узнать, что арбитр доступен. То есть либо через пинг, либо посредством какой-нибудь эвристики - этот механизм реализуется на усмотрение разработчика. Потому что при отсутствии арбитра средства могут оказаться заблокированными на адресе.

Итак, как только покупатель сделает свой единственный шаг, у него появится готовый аккаунт, и он сможет пополнить счёт, сделать предложение о снятии средств со счёта и отправить соответствующую информацию, например, сообщения, созданные им в процессе настройки аккаунта. Он отправит всю эту информацию продавцу, который теперь сможет настроить свой собственный аккаунт. Продавцу важно пройти процесс настройки аккаунта. Для этого он использует базовые ключи покупателя и арбитра, а затем сотрудничает с арбитром, чтобы получить от него сообщения второго раунда. Он проводит второй раунд, выполняет валидацию после обмена ключами, после чего у него появляется готовый аккаунт. Но здесь есть две важные оговорки.

При отсутствии арбитра, продавцу необходимо принудительно обновить свой аккаунт, чтобы средства, которые уже находятся на счёте, использующем схему мультиподписи, могли быть удалены с него тем или иным способом. В данном случае я предлагаю идти по пути возврата средств, поскольку продавец ещё не отправил товар, и, поскольку арбитр отсутствует, мы можем вернуть деньги и прервать процесс. И, конечно же, важно, чтобы арбитр проверял сообщения покупателей, потому что они передаются арбитру через продавца. Так что продавец может заменить сообщения покупателя на любые другие и, возможно, таким образом создать ложного покупателя. Позже я расскажу, как это предотвратить.

А здесь описан процесс настройки эскроу. Продавец подготавливает свой аккаунт и предлагает свой товар. Покупатель получает эту информацию, в один шаг настраивает свой аккаунт, отправляет средства на счёт по схеме мультиподписи, а затем сразу же создаёт предложение по проведению транзакций по схеме мультиподписи, удаляя средства со счёт. И в случае с Seraphis это можно сделать, не дожидаясь, пока средства со счёта, настроенного по схеме мультиподписи, поступят на нужный счёт, чтобы их разблокировали. Таким образом, не приходится ожидать в течение 10 блоков, потому что в Seraphis предложения по проведению транзакций по схеме мультиподписи могут быть отвязаны от выходов, которые ещё не были разблокированы или вообще не находятся в блокчейне. А затем, когда продавец получит всю эту информацию, он заполнит счёт арбитра, подождёт, пока средства не будут разблокированы, или же подтверждены и разблокированы на счёте, а затем отправит товар, а ему будут переведены средства.

А вот путь сотрудничества, о котором я уже говорил и на который уже намекал. Когда покупатель инициирует сделку, мы делаем то же самое, поэтому речь идёт именно о переводе средств. Итак, когда покупатель инициирует сделку, он делает предложение по проведении транзакции оплаты и возврата средств, инициализирует эти операции и отправляет всю эту информацию продавцу. И мы стараемся проводить платеж и возврат средств параллельно, насколько это возможно, чтобы улучшить опыт пользовательского взаимодействия.

Как я уже говорил, инициализация сделки происходит на том же этапе, что и настройка аккаунта покупателем. То есть покупатель создаёт свой аккаунт, пополняет счёт по схеме мультиподписи и инициализирует сделку. А затем продавец получает эту информацию от покупателя и начинает перевод. И если предположить, что арбитр отсутствует, то мы просто переходим к процессу возврата средств. В других случаях мы параллельно выполняем и платёж, и возврат.

Итак, на этапе завершения настройки продавец заполняет свой счёт у арбитра и отправляет товар покупателю, а также инициализирует транзакции оплаты и возврата. Это те самые нонсы, о которых я говорил ранее. А также частичные подписи, предназначенные только для процесса оплаты. Для возврата частичные подписи не нужны. В противном случае покупатель мог бы просто немедленно вернуть деньги. Затем покупатель получает всю эту информацию и либо получает товар, либо не получает его. Если он получает товар, он выбирает путь оплаты. Он завершает платёжную транзакцию, отправляет её в сеть, передаёт идентификатор транзакции продавцу, и затем продавец может проверить, были ли отправлены средства, и завершить сделку. Если покупатель пойдёт по пути возврата средств, то он частично подпишет транзакцию возврата и отправит эту информацию продавцу. В случае возврата средств продавцу предстоит выполнить ещё один шаг: завершить транзакцию, отправить её, а затем отправить идентификатор транзакции покупателю.

Теперь, если путь сотрудничества, или, как я его называю, маршрут сотрудничества не срабатывает, необходимо пройти через арбитраж. Допустим, покупатель хочет вернуть средства, а продавец не идёт на сотрудничество. Тогда он отправляет арбитру подробную информацию о настройках аккаунта, чтобы тот смог завершить работу со своим счётом. Он также создает предложение о проведении транзакции возврата, инициализирует её и отправляет арбитру, чтобы арбитр мог на следующем этапе одобрить возврат, проверить, что счёт был надлежащим образом пополнен после создания. Таким образом, арбитр в один шаг принудительно обновляет свой счёт, используя только данные раунда, полученные от покупателя в дополнение к базовым ключам продавца, которые могут быть обналичены арбитром. Таким образом, арбитр может обналичить средства, а продавец должен зарегистрироваться у арбитра, чтобы затем арбитр мог проверить, что информация о продавце, отправленная покупателем, зарегистрирована правильно. После этого, конечно же, арбитр подпишет транзакцию возврата, отправит её покупателю, а покупатель завершит перевод. Всё очень просто.

Кроме того, существует зеркальный маршрут арбитража оплаты, если продавец хочет получить её. И здесь все шаги аналогичны. Информация для принудительного обновления аккаунта отправляется арбитру. Арбитр в один шаг подписывает платёж, а продавец завершает его.

Итак, это основные детали процесса эскроу-торговли, которому посвящено моё выступление. Но есть масса сценариев, по которым всё может пойти совершенно не по плану. И нам следует немного поговорить о некоторых из них, пройтись по некоторым правилам безопасности.

Одна из самых больших опасностей - это подлог. Покупатель и арбитр обычно не контактируют друг с другом. Продавец передаёт информацию о покупателе арбитру на этапе настройки, а также когда продавец обращается к арбитру с запросом арбитража. Поэтому, чтобы не допустить изменения продавцом сообщений покупателей, мы требуем, чтобы все транзакции перевода средств на счёт, на которые ссылаются предложения проведения транзакций по схеме мультиподписи, включали определённые доказательства. Доказательство финансирования транзакции - это доказательство того, что подписавший доказательство отправил средства или создал транзакцию, или финансировал определённую транзакцию. Таким образом, все транзакции перевода средств на счёт по схеме мультиподписи должны иметь доказательство финансирования, подписывающее сообщение покупателя. То есть информацию о покупателе, количестве продукта продавца и подпись продавца на информации о продукте. Таким образом, продукт, перевод, который осуществляется в данном случае, фиксируется в доказательстве финансирования транзакции. И только покупатель может совершить эту транзакцию, потому что только он пополняет счёт. И даже если продавец пополнит счёт и предоставит одно из этих доказательств финансирования транзакции, арбитр не станет работать с каким-либо предложением о проведении транзакции, в которой должны будут расходоваться средства, полученные в транзакции, не имеющей доказательства финансирования, которое будет совпадать с информацией о покупателе, отправленной продавцом. Таким образом, это не позволит продавцу создавать подложных покупателей, которые смогли бы вывести средства со счёта без соблюдения надлежащего порядка или без нарушения надлежащей инвариантности.

С другой стороны, когда покупатель обращается в арбитраж для получения возмещения от арбитра, возможно, что он уже заранее зарегистрировал подложного продавца у арбитра и использует его, чтобы убедить арбитра в необходимости возврата средств. Чтобы предотвратить это, арбитр должен следить за тем, чтобы открытые ключи продавцов, которые используются при наличии множества ставок, были уникальными. Мы ожидаем, что продавец будет регистрировать свои базовые ключи только перед предложением продукта. Таким образом, между продавцом и покупателем не будет соревнования. И, конечно же, требуется, чтобы арбитр проверял наличие подписи в виде зарегистрированного идентификатора продавца во всех его сообщениях.

Теперь мы можем увидеть, почему оптимизация, о которой я говорил на протяжении всей беседы, оправдана. Итак, существует четыре сценария. Во время настройки аккаунта покупателем продавец и арбитр инициируют бустинг второго раунда, а затем покупатель использует полученные сообщения для бустинга второго раунда со своей стороны. Это допустимо, поскольку продавцу и арбитру пока что не нужен аккаунт. Таким образом, покупатель может продолжить создание своего аккаунта, не взаимодействуя с продавцом и арбитром.

Также во время настройки аккаунта покупателем мы принудительно обновляем раунд верификации после обмена ключами, что я считаю допустимым, поскольку мы предполагаем, что арбитр честен и доступен. И мы заранее знаем, что любой арбитраж возврата средств может быть завершён только покупателем и арбитром. Поэтому нет необходимости проверять, доступен ли продавец или нет, так как для настройки аккаунта арбитра требуется только покупатель. Если же арбитра нет, а продавцу нужно произвести возврат, он использует принудительное обновление, выполняет второй и третий раунды, что правильно, поскольку продавец находится в процессе возврата и не имеет доли в средствах, находящихся на счёте, созданном по схеме мультиподписи. Таким образом, только покупатель имеет долю, и только он предоставляет сообщения обмена ключами.

При обоих сценариях арбитража арбитр принудительно обновляет оба раунда, второй и третий, что я также считаю правильным, поскольку арбитр не имеет доли. И перед созданием счёта арбитр уже решил, что партнёр по созданию счёта, который сотрудничает в этой ситуации с принудительным обновлением, имеет полную долю средств на счёте, созданном по схеме мультиподписи. Так что даже если нет никаких причин для нарушения какого-либо из обычных вариантов построения мультиподписи, этот партнёр ничего не получит.

И наконец, если нам нужен арбитраж, а арбитра нет, то как запасной вариант мы можем технически реализовать протокол разделения средств между продавцом и покупателем. Кроме того, важно отметить, что в рамках этого протокола покупатель в отличие от арбитра при реализации сценария сотрудничества обладает конфиденциальностью. Поэтому в большинстве случаев арбитр ничего не узнает о покупателе, так как он может помочь продавцу, не обладая контактными данными покупателя. Арбитру не нужно ничего подтверждать, ему не нужны доказательства финансирования транзакций, или же они ему потребуются только при проведении арбитража. Таким образом, информацию о покупателе не нужно отправлять арбитру, за исключением случаев арбитража. И что важно, арбитр не узнает о покупателе ничего, кроме его базовых ключей и ключей второго раунда при продвижении по обычному сценарию.

На этом у меня всё. Спасибо.
